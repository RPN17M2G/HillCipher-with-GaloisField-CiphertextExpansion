name: Linux Workflow

on:
  push:
    branches: [main]
  pull_request:
    branches: [ main ]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - run: sudo apt-get update && sudo apt-get install -y cmake build-essential
      - run: sudo cmake -S GaloisFieldHillCipher -B GaloisFieldHillCipher/build
      - run: sudo cmake --build GaloisFieldHillCipher/build -- -j$(nproc)
      - uses: actions/upload-artifact@v4
        with:
          name: build-linux
          path: GaloisFieldHillCipher/build/**

  test-linux:
    needs: build-linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build-linux
          path: ./GaloisFieldHillCipher/build
      - run: chmod +x ./GaloisFieldHillCipher/build/UnitTests
      - run: ./GaloisFieldHillCipher/build/UnitTests

  valgrind-memory-test:
    needs: build-linux
    runs-on: ubuntu-latest

    steps:
      - run: sudo apt-get update && sudo apt-get install -y valgrind
      - uses: actions/download-artifact@v4
        with:
          name: build-linux
          path: ./GaloisFieldHillCipher/build
      - run: chmod +x ./GaloisFieldHillCipher/build/GaloisFieldHillCipher
      - run: echo "Example plaintext" > plaintext.txt
      - name: Valgrind - Generate encryption key (ek)
        run: |
          valgrind --leak-check=full \
                   --show-leak-kinds=all \
                   --track-origins=yes \
                   --verbose \
                   --error-exitcode=1 \
                   --log-file=valgrind-ek.txt \
                   ./GaloisFieldHillCipher/build/GaloisFieldHillCipher -m ek -o encryption_key.bin -d 3
      - name: Valgrind - Generate decryption key (dk)
        run: |
          valgrind --leak-check=full \
                   --show-leak-kinds=all \
                   --track-origins=yes \
                   --verbose \
                   --error-exitcode=1 \
                   --log-file=valgrind-dk.txt \
                   ./GaloisFieldHillCipher/build/GaloisFieldHillCipher -m dk -k encryption_key.bin -o decryption_key.bin -d 3
      - name: Valgrind - Encrypt (e)
        run: |
          valgrind --leak-check=full \
                   --show-leak-kinds=all \
                   --track-origins=yes \
                   --verbose \
                   --error-exitcode=1 \
                   --log-file=valgrind-e.txt \
                   ./GaloisFieldHillCipher/build/GaloisFieldHillCipher -m e -i plaintext.txt -o encrypted.bin -k encryption_key.bin -d 3
      - name: Valgrind - Decrypt (d)
        run: |
          valgrind --leak-check=full \
                   --show-leak-kinds=all \
                   --track-origins=yes \
                   --verbose \
                   --error-exitcode=1 \
                   --log-file=valgrind-d.txt \
                   ./GaloisFieldHillCipher/build/GaloisFieldHillCipher -m d -i encrypted.bin -o decrypted.txt -k decryption_key.bin -d 3
      - name: Valgrind - Generate and encrypt (ge)
        run: |
          valgrind --leak-check=full \
                   --show-leak-kinds=all \
                   --track-origins=yes \
                   --verbose \
                   --error-exitcode=1 \
                   --log-file=valgrind-ge.txt \
                   ./GaloisFieldHillCipher/build/GaloisFieldHillCipher -m ge -i plaintext.txt -o ge_encrypted.bin -k ge_key.bin -d 3
      - name: Valgrind - Generate and decrypt (gd)
        run: |
          valgrind --leak-check=full \
                   --show-leak-kinds=all \
                   --track-origins=yes \
                   --verbose \
                   --error-exitcode=1 \
                   --log-file=valgrind-gd.txt \
                   ./GaloisFieldHillCipher/build/GaloisFieldHillCipher -m gd -i encrypted.bin -o gd_decrypted.txt -k encryption_key.bin -d 3
